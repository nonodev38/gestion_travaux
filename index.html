<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üìã Gestion Travaux</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
      color: #333;
    }
    h2 {
      margin-bottom: 1rem;
    }
    ul {
      list-style-type: none;
      padding: 0;
      max-height: 800px;
      overflow-y: auto;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 6px;
    }
    li {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    li:last-child {
      border-bottom: none;
    }
    .title {
      font-weight: bold;
      font-size: 2em;
      margin-bottom: 4px;
      color: #007acc;
    }
    .subtitle {
      font-size: 1.2em;
      color: #555;
      white-space: pre-wrap;
    }
    .btn-ajouter {
      margin-bottom: 1rem;
      padding: 10px 16px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .form-container {
      display: none;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .form-container label {
      display: block;
      margin: 0.5rem 0 0.2rem;
    }
    .form-container input,
    .form-container select {
      width: 100%;
      padding: 8px;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .form-container button {
      padding: 8px 12px;
      margin-right: 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-container button.delete {
      background: #dc3545;
    }
    .modifier-btn {
      margin-top: 8px;
      padding: 6px;
      background: #ffc107;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .date-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .date-wrapper input[type="date"] {
      padding-left: 36px; /* espace pour l'ic√¥ne */
    }
    
    .date-wrapper::before {
      content: "üìÖ";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1em;
      pointer-events: none;
    }
    
  </style>
</head>
<body>

  <h2>üìã Liste Travaux √† Effectuer</h2>

  <button class="btn-ajouter" onclick="toggleForm()">+ Ajouter Une Fiche</button>
  <button class="btn-ajouter" onclick="exporterTravaux()">üì§ Exporter les travaux en .txt</button>
  <input type="file" id="importFile" accept=".txt" />
  <button onclick="importerTravaux()">üìÇ Importer Travaux</button>
  <button onclick="supprimerTousTravaux()" style="background:#dc3545; color:white; border:none; padding:10px 16px; border-radius:5px; cursor:pointer;">
  üóëÔ∏è Supprimer tous les travaux
  </button>



  <div class="form-container" id="formContainer">
    <input type="hidden" id="ficheId" />

    <label for="type">Type</label>
    <select id="type">
      <option value="MH">MH</option>
      <option value="CH">CH</option>
      <option value="EMP">EMP</option>
      <option value="BAT">BAT</option>
    </select>

    <label for="numero">Num√©ro</label>
    <input type="text" id="numero" placeholder="Entrez un num√©ro" />

    <label for="famille">Famille Travaux</label>
    <select id="famille">
      <option value="Deco">Deco</option>
      <option value="Electricit√©">Electricit√©</option>
      <option value="Fenetre">Fenetre</option>
      <option value="MobilHome">MobilHome</option>
      <option value="Plomberie">Plomberie</option>
      <option value="Porte">Porte</option>
      <option value="Probl√®meInsectes">Probl√®me insectes</option>
      <option value="Terrasse">Terrasse</option>
      <option value="Casse Int√©rieur">Casse Int√©rieur</option>
    </select>

    <label for="precision">Pr√©cision des travaux</label>
    <input type="text" id="precision" placeholder="Pr√©cision des travaux" />

    <label for="date">Date s√©lectionn√©e</label>
    <div class="date-wrapper">
      <input type="date" id="date" />
    </div>

    <button onclick="validerFiche()">Valider</button>
    <button class="delete" id="btnSupprimer" onclick="supprimerFiche()" style="display:none;">Supprimer</button>
    
  </div>

  <ul id="travauxList"></ul>

  <script>
    let travaux = JSON.parse(localStorage.getItem('travaux')) || [];

    function parseDateDDMMYYYY(str) {
      const [y, m, d] = str.split('-');
      return new Date(`${y}-${m}-${d}`);
    }

    function afficherTravaux() {
      travaux.sort((b, a) => parseDateDDMMYYYY(b.dateSelection) - parseDateDDMMYYYY(a.dateSelection));
      const list = document.getElementById('travauxList');
      list.innerHTML = '';

      travaux.forEach(item => {
        const li = document.createElement('li');

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = `${item.type} ${item.numero}`;

        const subtitle = document.createElement('div');
        subtitle.className = 'subtitle';
        const formatFr = d => d ? new Date(d).toLocaleDateString('fr-FR') : '';
        subtitle.textContent = [
          item.famille,
          item.precision,
          item.dateAjout,
          formatFr(item.dateSelection)
        ].filter(Boolean).join(' | ');

        const btnModif = document.createElement('button');
        btnModif.className = 'modifier-btn';
        btnModif.textContent = '‚úèÔ∏è Modifier';
        btnModif.onclick = () => modifierFiche(item.id);

        li.appendChild(title);
        li.appendChild(subtitle);
        li.appendChild(btnModif);

        list.appendChild(li);
      });
    }
    
    function toggleForm() {
      const form = document.getElementById('formContainer');
      const isCurrentlyHidden = form.style.display === 'none' || !form.style.display;
    
      if (isCurrentlyHidden) {
        // On ouvre le formulaire
        form.style.display = 'block';
    
        // Remplir la date du jour
        const dateInput = document.getElementById('date');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      } else {
        // On ferme le formulaire
        form.style.display = 'none';
        clearForm();
      }
    }

    function clearForm() {
      document.getElementById('ficheId').value = '';
      document.getElementById('type').value = 'MH';
      document.getElementById('numero').value = '';
      document.getElementById('famille').value = 'Deco';
      document.getElementById('precision').value = '';
      document.getElementById('date').value = '';
      document.getElementById('btnSupprimer').style.display = 'none';
    }

    function validerFiche() {
      const id = document.getElementById('ficheId').value;
      const type = document.getElementById('type').value;
      const numero = document.getElementById('numero').value.trim();
      const famille = document.getElementById('famille').value;
      const precision = document.getElementById('precision').value.trim();
      const dateSelection = document.getElementById('date').value;
      const dateAjout = new Date().toLocaleDateString('fr-FR');

      if (!numero || !dateSelection) {
        alert("Le num√©ro et la date sont requis.");
        return;
      }

      if (id) {
        // modification
        const i = travaux.findIndex(t => t.id == id);
        travaux[i] = { id: Number(id), type, numero, famille, precision, dateAjout: travaux[i].dateAjout, dateSelection };
      } else {
        // ajout
        const newId = travaux.length ? Math.max(...travaux.map(t => t.id)) + 1 : 1;
        travaux.push({ id: newId, type, numero, famille, precision, dateAjout, dateSelection });
      }

      localStorage.setItem('travaux', JSON.stringify(travaux));
      afficherTravaux();
      toggleForm();
      clearForm();
    }

    function supprimerFiche() {
      const id = document.getElementById('ficheId').value;
      if (confirm("Supprimer cette fiche ?")) {
        travaux = travaux.filter(t => t.id != id);
        localStorage.setItem('travaux', JSON.stringify(travaux));
        afficherTravaux();
        toggleForm();
        clearForm();
      }
    }

    function supprimerTousTravaux() {
      if (confirm("‚ùó Cette action supprimera tous les travaux enregistr√©s dans le navigateur. √ätes-vous s√ªr ?")) {
        localStorage.removeItem('travaux');
        afficherTravaux();
        alert("Tous les travaux ont √©t√© supprim√©s !");
      }
    }    

    function modifierFiche(id) {
      const f = travaux.find(t => t.id === id);
      if (!f) return;
      document.getElementById('ficheId').value = f.id;
      document.getElementById('type').value = f.type;
      document.getElementById('numero').value = f.numero;
      document.getElementById('famille').value = f.famille;
      document.getElementById('precision').value = f.precision;
      document.getElementById('date').value = f.dateSelection;
      document.getElementById('btnSupprimer').style.display = 'inline-block';
      document.getElementById('formContainer').style.display = 'block';
    }

    function exporterTravaux() {
      const contenu = travaux.map(t =>
        `${t.id},${t.dateAjout},${t.type},${t.numero},${t.famille},${t.precision},${t.dateSelection}`
      ).join('\n');

      const blob = new Blob([contenu], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bdTravaux.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function importerTravaux() {
    const input = document.getElementById('importFile');
    const file = input.files[0];
    if (!file) {
      alert("Veuillez s√©lectionner un fichier .txt √† importer.");
      return;
    }

  const reader = new FileReader();
  reader.onload = function (e) {
    const contenu = e.target.result;
    const lignes = contenu.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    let travauxLocal = JSON.parse(localStorage.getItem('travaux')) || [];
    const idsExistants = new Set(travauxLocal.map(t => t.id));
    let maxId = travauxLocal.reduce((max, t) => Math.max(max, t.id || 0), 0);

    lignes.forEach(ligne => {
      const parts = ligne.split(',');
      if (parts.length < 7) return;

      let id = parseInt(parts[0], 10);
      const dateAjout = parts[1].trim();
      const type = parts[2].trim();
      const numero = parts[3].trim();
      const famille = parts[4].trim();
      const precision = parts[5].trim();
      const dateSelection = parts[6].trim();

      if (idsExistants.has(id)) {
        id = ++maxId; // attribuer un nouvel ID unique
      }

      travauxLocal.push({
        id,
        dateAjout,
        type,
        numero,
        famille,
        precision,
        dateSelection
      });

      idsExistants.add(id);
    });

    localStorage.setItem('travaux', JSON.stringify(travauxLocal));
    afficherTravaux();
    alert("Importation termin√©e !");
  };

  reader.readAsText(file);
}
    

    // init
    afficherTravaux();
  </script>
</body>
</html>
