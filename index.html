<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“‹ Gestion Travaux avec Import/Export</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .form-container {
      border: 1px solid #ddd;
      background: #fff;
      padding: 1rem;
      max-width: 800px;
      margin: 0 auto 2rem auto;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      display: none;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      margin-top: 4px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1rem;
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button#btnSupprimer {
      background-color: #d9534f;
      color: white;
      margin-left: 1rem;
      display: none;
    }
    button#btnValider {
      background-color: #5cb85c;
      color: white;
    }
    button#btnAjouter, button#btnSupprimerTous {
      background-color: #0275d8;
      color: white;
      margin: 0 0.5rem 1rem 0.5rem;
    }
    ul#travauxList {
      list-style: none;
      padding: 0;
      max-width: 1000px;
      margin: 0 auto;
    }
    ul#travauxList li {
      background: #fff;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    ul#travauxList li .title {
      font-weight: bold;
      font-size: 2rem;
    }
    ul#travauxList li .subtitle {
      font-size: 1.4rem;
      color: #666;
      margin-top: 0.3rem;
    }
    ul#travauxList li button.modifier-btn {
      background-color: #f0ad4e;
      color: white;
      border-radius: 4px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
    }
    .date-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    .date-container .calendar-icon {
      position: absolute;
      left: 10px;
      font-size: 1.2em;
      pointer-events: none;
      color: #999;
    }
    .date-container input {
      padding-left: 32px;
      width: 100%;
    }
    #importExportSection {
      text-align: center;
      margin-bottom: 2rem;
    }
    #importExportSection button {
      margin: 0 1rem;
    }
  </style>
</head>
<body>
  <h1>ðŸ“‹ Gestion des Travaux avec Import/Export</h1>

  <div id="importExportSection">
    <input type="file" id="importFile" accept=".txt" style="display:none" />
    <button id="btnImport">â¬† Importer bdTravaux.txt</button>
    <button id="btnExport">â¬‡ Exporter bdTravaux.txt</button>
  </div>

  <div style="text-align:center; margin-bottom:1rem;">
    <button id="btnAjouter">âž• Ajouter un travail</button>
    <button id="btnSupprimerTous">ðŸ—‘ Supprimer tous les travaux</button>
  </div>

  <div class="form-container" id="formContainer">
    <input type="hidden" id="ficheId" />
    <label for="type">Type</label>
    <select id="type">
      <option value="MH">MH</option>
      <option value="ML">ML</option>
      <option value="PF">PF</option>
      <option value="CO">CO</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="numero">NumÃ©ro</label>
    <input type="text" id="numero" placeholder="NumÃ©ro" />

    <label for="famille">Famille</label>
    <select id="famille">
      <option value="Deco">Deco</option>
      <option value="Plomberie">Plomberie</option>
      <option value="ElectricitÃ©">ElectricitÃ©</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="precision">PrÃ©cision</label>
    <input type="text" id="precision" placeholder="PrÃ©cision (optionnelle)" />

    <label for="date">Date sÃ©lectionnÃ©e</label>
    <div class="date-container">
      <span class="calendar-icon">ðŸ—“</span>
      <input type="text" id="date" placeholder="SÃ©lectionnez une date" />
    </div>

    <div style="margin-top:1rem;">
      <button id="btnValider">Valider</button>
      <button id="btnSupprimer">Supprimer</button>
    </div>
  </div>

  <input
    type="text"
    id="rechercheInput"
    placeholder="ðŸ” Rechercher un travail..."
    style="width: 100%; padding: 10px; margin: 1rem 0; border: 1px solid #ccc; border-radius: 6px;"
  />
  <ul id="travauxList"></ul>

  <script>
    let travaux = JSON.parse(localStorage.getItem('travaux')) || [];

    function parseDateDDMMYYYY(str) {
      if (!str) return null;
      const [d, m, y] = str.split('/');
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }

    function afficherTravaux(filtre = '') {
      const list = document.getElementById('travauxList');
      list.innerHTML = '';

      const recherche = filtre.trim().toLowerCase();

      const travauxFiltres = travaux
        .sort((b, a) => parseDateDDMMYYYY(b.dateSelection) - parseDateDDMMYYYY(a.dateSelection))
        .filter(item => {
          const chaine = `${item.type} ${item.numero} ${item.famille} ${item.precision} ${item.dateAjout} ${item.dateSelection}`;
          return chaine.toLowerCase().includes(recherche);
        });

      travauxFiltres.forEach(item => {
        const li = document.createElement('li');

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = `${item.type} ${item.numero}`;

        const subtitle = document.createElement('div');
        subtitle.className = 'subtitle';
        const formatFr = d => d ? new Date(d).toLocaleDateString('fr-FR') : '';
        subtitle.textContent = [
          item.famille,
          item.precision,
          item.dateAjout,
          formatFr(item.dateSelection)
        ].filter(Boolean).join(' | ');

        const btnModif = document.createElement('button');
        btnModif.className = 'modifier-btn';
        btnModif.textContent = 'âœï¸ Modifier';
        btnModif.onclick = () => modifierFiche(item.id);

        li.appendChild(title);
        li.appendChild(subtitle);
        li.appendChild(btnModif);

        list.appendChild(li);
      });
    }

    document.getElementById('rechercheInput').addEventListener('input', function () {
      afficherTravaux(this.value);
    });

    // ... (reste du script inchangÃ©, y compris les fonctions : toggleForm, validerFiche, supprimerFiche, modifierFiche, importerFichier, exporterFichier)

    // Initialisation
    flatpickr("#date", {
      dateFormat: "d/m/Y",
      defaultDate: "today",
      locale: "fr"
    });

    document.getElementById('btnAjouter').addEventListener('click', toggleForm);
    document.getElementById('btnValider').addEventListener('click', validerFiche);
    document.getElementById('btnSupprimer').addEventListener('click', supprimerFiche);
    document.getElementById('btnSupprimerTous').addEventListener('click', supprimerTousTravaux);

    const importFileInput = document.getElementById('importFile');
    document.getElementById('btnImport').addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        importerFichier(e.target.files[0]);
        e.target.value = '';
      }
    });
    document.getElementById('btnExport').addEventListener('click', exporterFichier);

    afficherTravaux();
  </script>
</body>
</html>
