<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>📋 Gestion Travaux</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem auto;
      background: #f9f9f9;
      color: #333;
      max-width: 1000px;
    }
    h1 {
      text-align: center;
    }
    .form-container, .liste-realisation {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .form-container {
      display: none;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1rem;
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button#btnSupprimer {
      background-color: #d9534f;
      color: white;
      margin-left: 1rem;
      display: none;
    }
    button#btnValider {
      background-color: #5cb85c;
      color: white;
    }
    button#btnAjouter, button#btnSupprimerTous {
      background-color: #0275d8;
      color: white;
      margin: 0 0.5rem 1rem 0.5rem;
    }
    #travauxList {
      list-style: none;
      padding: 0;
    }
    #travauxList li {
      background: #fff;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #travauxList li .title {
      font-weight: bold;
      font-size: 1.2rem;
    }
    #travauxList li .subtitle {
      font-size: 0.9rem;
      color: #666;
    }
    .date-container {
      position: relative;
      display: flex;
      align-items: center;
      max-width: 300px;
    }
    .calendar-icon {
      position: absolute;
      left: 10px;
      font-size: 1.2em;
      color: #555;
    }
    .date-container input {
      padding-left: 35px;
    }
    #rechercheInput {
      width: 100%;
      padding: 10px;
      margin: 1rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .liste-realisation {
      position: fixed;
      top: 1rem;
      left: 1rem;
      max-width: 250px;
      z-index: 1000;
    }
    .liste-realisation h3 {
      margin: 0 0 0.5rem;
    }
    .liste-realisation li {
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>📋 Gestion des Travaux</h1>

  <div class="liste-realisation" id="listeRealisationContainer" style="display:none;">
    <h3>🛠 À réaliser</h3>
    <ul id="listeRealisation"></ul>
  </div>

  <div style="text-align:center;">
    <button id="btnAjouter">➕ Ajouter un travail</button>
    <button id="btnSupprimerTous">🗑 Supprimer tous les travaux</button>
  </div>

  <div class="form-container" id="formContainer">
    <input type="hidden" id="ficheId" />
    <label for="type">Type</label>
    <select id="type">
      <option value="MH">MH</option>
      <option value="CH">CH</option>
      <option value="EMP">EMP</option>
      <option value="BAT">BAT</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="numero">Numéro</label>
    <input type="text" id="numero" placeholder="Numéro" />

    <label for="famille">Famille</label>
    <select id="famille">
      <option value="Casse">Casse</option>
      <option value="Deco">Deco</option>
      <option value="Plomberie">Plomberie</option>
      <option value="Electricité">Electricité</option>
      <option value="Terrasse">Terrasse</option>
      <option value="Debrousaillage">Débroussaillage</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="precision">Précision</label>
    <input type="text" id="precision" list="precision-list" placeholder="Précisions Travaux" />
    <datalist id="precision-list"></datalist>

    <label for="date">Date sélectionnée</label>
    <div class="date-container">
      <span class="calendar-icon">📅</span>
      <input type="text" id="date" placeholder="Sélectionnez une date" />
    </div>

    <button id="btnValider">Valider</button>
    <button id="btnSupprimer">Supprimer</button>
  </div>

  <input type="text" id="rechercheInput" placeholder="🔍 Rechercher un travail..." />
  <ul id="travauxList"></ul>

  <script>
    const travaux = JSON.parse(localStorage.getItem("travaux")) || [];

    function afficherTravaux(filtre = '') {
      const list = document.getElementById("travauxList");
      list.innerHTML = '';
      const recherche = filtre.toLowerCase();

      travaux
        .filter(t => `${t.type} ${t.numero} ${t.famille} ${t.precision}`.toLowerCase().includes(recherche))
        .forEach(item => {
          const li = document.createElement("li");
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = `${item.type} ${item.numero}`;

          const subtitle = document.createElement("div");
          subtitle.className = "subtitle";
          subtitle.textContent = `${item.famille} | ${item.precision} | ${item.dateAjout} | ${item.dateSelection}`;

          const btn = document.createElement("button");
          btn.textContent = "✏️ Modifier";
          btn.onclick = () => modifierFiche(item.id);

          li.onclick = e => {
            if (e.target.tagName !== 'BUTTON') ajouterDansListeARealiser(item);
          };

          li.appendChild(title);
          li.appendChild(subtitle);
          li.appendChild(btn);
          list.appendChild(li);
        });
    }

    function validerFiche() {
      const id = document.getElementById("ficheId").value;
      const type = document.getElementById("type").value;
      const numero = document.getElementById("numero").value;
      const famille = document.getElementById("famille").value;
      const precision = document.getElementById("precision").value;
      const date = document.getElementById("date").value;
      const dateAjout = new Date().toLocaleDateString("fr-FR");

      if (!numero || !date) return alert("Champs requis");

      const nouveau = { id: id || Date.now(), type, numero, famille, precision, dateSelection: date, dateAjout };

      if (id) {
        const idx = travaux.findIndex(t => t.id == id);
        if (idx !== -1) travaux[idx] = nouveau;
      } else {
        travaux.push(nouveau);
      }

      localStorage.setItem("travaux", JSON.stringify(travaux));
      afficherTravaux();
      document.getElementById("formContainer").style.display = "none";
    }

    function modifierFiche(id) {
      const t = travaux.find(tr => tr.id == id);
      if (!t) return;
      Object.entries(t).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      document.getElementById("btnSupprimer").style.display = "inline-block";
      document.getElementById("formContainer").style.display = "block";
    }

    function supprimerTousTravaux() {
      if (confirm("Confirmer suppression")) {
        localStorage.removeItem("travaux");
        location.reload();
      }
    }

    function ajouterDansListeARealiser(travail) {
      let liste = JSON.parse(localStorage.getItem("listeTravauxARealiser")) || [];
      if (!liste.find(t => t.id === travail.id)) {
        liste.push(travail);
        localStorage.setItem("listeTravauxARealiser", JSON.stringify(liste));
        chargerListeARealiser();
      }
    }

    function chargerListeARealiser() {
      const liste = JSON.parse(localStorage.getItem("listeTravauxARealiser")) || [];
      const ul = document.getElementById("listeRealisation");
      ul.innerHTML = '';
      if (!liste.length) return document.getElementById("listeRealisationContainer").style.display = "none";

      document.getElementById("listeRealisationContainer").style.display = "block";
      liste.forEach(t => {
        const li = document.createElement("li");
        li.textContent = `${t.type} ${t.numero} (${t.dateSelection})`;
        li.onclick = () => {
          const newList = liste.filter(x => x.id !== t.id);
          localStorage.setItem("listeTravauxARealiser", JSON.stringify(newList));
          chargerListeARealiser();
        };
        ul.appendChild(li);
      });
    }

    document.getElementById("btnAjouter").onclick = () => {
      document.getElementById("formContainer").style.display = "block";
      document.getElementById("ficheId").value = '';
    };
    document.getElementById("btnValider").onclick = validerFiche;
    document.getElementById("btnSupprimerTous").onclick = supprimerTousTravaux;
    document.getElementById("rechercheInput").oninput = e => afficherTravaux(e.target.value);
    flatpickr("#date", { dateFormat: "d/m/Y", locale: "fr" });

    afficherTravaux();
    chargerListeARealiser();

    // Chargement auto des précisions depuis bdTravaux
    const bdTravaux = JSON.parse(localStorage.getItem("bdTravaux")) || [];
    const precisions = [...new Set(bdTravaux.map(l => (l.split("\u00a7")[4] || '').trim()).filter(Boolean))];
    const datalist = document.getElementById("precision-list");
    precisions.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      datalist.appendChild(option);
    });
  </script>
</body>
</html>
