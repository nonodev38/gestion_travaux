<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“‹ Gestion Travaux</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
      color: #333;
    }
    h2 {
      margin-bottom: 1rem;
    }
    ul {
      list-style-type: none;
      padding: 0;
      max-height: 800px;
      overflow-y: auto;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 6px;
    }
    li {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    li:last-child {
      border-bottom: none;
    }
    .title {
      font-weight: bold;
      font-size: 2em;
      margin-bottom: 4px;
      color: #007acc;
    }
    .subtitle {
      font-size: 1.2em;
      color: #555;
      white-space: pre-wrap;
    }
    .btn-ajouter {
      margin-bottom: 1rem;
      padding: 10px 16px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .form-container {
      display: none;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .form-container label {
      display: block;
      margin: 0.5rem 0 0.2rem;
    }
    .form-container input,
    .form-container select {
      width: 100%;
      padding: 8px;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .form-container button {
      padding: 8px 12px;
      margin-right: 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-container button.delete {
      background: #dc3545;
    }
    .modifier-btn {
      margin-top: 8px;
      padding: 6px;
      background: #ffc107;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>ðŸ“‹ Liste Travaux Ã  Effectuer</h2>

  <button class="btn-ajouter" onclick="toggleForm()">+ Ajouter Une Fiche</button>
  <button class="btn-ajouter" onclick="exporterTravaux()">ðŸ“¤ Exporter les travaux en .txt</button>

  <div class="form-container" id="formContainer">
    <input type="hidden" id="ficheId" />

    <label for="type">Type</label>
    <select id="type">
      <option value="MH">MH</option>
      <option value="CH">CH</option>
      <option value="EMP">EMP</option>
      <option value="BAT">BAT</option>
    </select>

    <label for="numero">NumÃ©ro</label>
    <input type="text" id="numero" placeholder="Entrez un numÃ©ro" />

    <label for="famille">Famille Travaux</label>
    <select id="famille">
      <option value="Deco">Deco</option>
      <option value="ElectricitÃ©">ElectricitÃ©</option>
      <option value="Fenetre">Fenetre</option>
      <option value="MobilHome">MobilHome</option>
      <option value="Plomberie">Plomberie</option>
      <option value="Porte">Porte</option>
      <option value="ProblÃ¨meInsectes">ProblÃ¨me insectes</option>
      <option value="Terrasse">Terrasse</option>
      <option value="Casse IntÃ©rieur">Casse IntÃ©rieur</option>
    </select>

    <label for="precision">PrÃ©cision des travaux</label>
    <input type="text" id="precision" placeholder="PrÃ©cision des travaux" />

    <label for="date">Date sÃ©lectionnÃ©e</label>
    <input type="date" id="date" />

    <button onclick="validerFiche()">Valider</button>
    <button class="delete" id="btnSupprimer" onclick="supprimerFiche()" style="display:none;">Supprimer</button>
  </div>

  <ul id="travauxList"></ul>

  <script>
    let travaux = JSON.parse(localStorage.getItem('travaux')) || [];

    function parseDateDDMMYYYY(str) {
      const [y, m, d] = str.split('-');
      return new Date(`${y}-${m}-${d}`);
    }

    function afficherTravaux() {
      travaux.sort((a, b) => parseDateDDMMYYYY(b.dateSelection) - parseDateDDMMYYYY(a.dateSelection));
      const list = document.getElementById('travauxList');
      list.innerHTML = '';

      travaux.forEach(item => {
        const li = document.createElement('li');

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = `${item.type} ${item.numero}`;

        const subtitle = document.createElement('div');
        subtitle.className = 'subtitle';
        const formatFr = d => d ? new Date(d).toLocaleDateString('fr-FR') : '';
        subtitle.textContent = [
          item.famille,
          item.precision,
          item.dateAjout,
          formatFr(item.dateSelection)
        ].filter(Boolean).join(' | ');

        const btnModif = document.createElement('button');
        btnModif.className = 'modifier-btn';
        btnModif.textContent = 'âœï¸ Modifier';
        btnModif.onclick = () => modifierFiche(item.id);

        li.appendChild(title);
        li.appendChild(subtitle);
        li.appendChild(btnModif);

        list.appendChild(li);
      });
    }

    function toggleForm() {
      const form = document.getElementById('formContainer');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'none') clearForm();
    }

    function clearForm() {
      document.getElementById('ficheId').value = '';
      document.getElementById('type').value = 'MH';
      document.getElementById('numero').value = '';
      document.getElementById('famille').value = 'Deco';
      document.getElementById('precision').value = '';
      document.getElementById('date').value = '';
      document.getElementById('btnSupprimer').style.display = 'none';
    }

    function validerFiche() {
      const id = document.getElementById('ficheId').value;
      const type = document.getElementById('type').value;
      const numero = document.getElementById('numero').value.trim();
      const famille = document.getElementById('famille').value;
      const precision = document.getElementById('precision').value.trim();
      const dateSelection = document.getElementById('date').value;
      const dateAjout = new Date().toLocaleDateString('fr-FR');

      if (!numero || !dateSelection) {
        alert("Le numÃ©ro et la date sont requis.");
        return;
      }

      if (id) {
        // modification
        const i = travaux.findIndex(t => t.id == id);
        travaux[i] = { id: Number(id), type, numero, famille, precision, dateAjout: travaux[i].dateAjout, dateSelection };
      } else {
        // ajout
        const newId = travaux.length ? Math.max(...travaux.map(t => t.id)) + 1 : 1;
        travaux.push({ id: newId, type, numero, famille, precision, dateAjout, dateSelection });
      }

      localStorage.setItem('travaux', JSON.stringify(travaux));
      afficherTravaux();
      toggleForm();
      clearForm();
    }

    function supprimerFiche() {
      const id = document.getElementById('ficheId').value;
      if (confirm("Supprimer cette fiche ?")) {
        travaux = travaux.filter(t => t.id != id);
        localStorage.setItem('travaux', JSON.stringify(travaux));
        afficherTravaux();
        toggleForm();
        clearForm();
      }
    }

    function modifierFiche(id) {
      const f = travaux.find(t => t.id === id);
      if (!f) return;
      document.getElementById('ficheId').value = f.id;
      document.getElementById('type').value = f.type;
      document.getElementById('numero').value = f.numero;
      document.getElementById('famille').value = f.famille;
      document.getElementById('precision').value = f.precision;
      document.getElementById('date').value = f.dateSelection;
      document.getElementById('btnSupprimer').style.display = 'inline-block';
      document.getElementById('formContainer').style.display = 'block';
    }

    function exporterTravaux() {
      const contenu = travaux.map(t =>
        `${t.id},${t.dateAjout},${t.type},${t.numero},${t.famille},${t.precision},${t.dateSelection}`
      ).join('\n');

      const blob = new Blob([contenu], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bdTravaux.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // init
    afficherTravaux();
  </script>
</body>
</html>
