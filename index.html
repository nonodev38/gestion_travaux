<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>📋 Gestion Travaux avec Import/Export</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  <style>
    /* (Style inchangé, identique à ce que j'ai déjà fourni) */
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .form-container {
      border: 1px solid #ddd;
      background: #fff;
      padding: 1rem;
      max-width: 500px;
      margin: 0 auto 2rem auto;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      display: none;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      margin-top: 4px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1rem;
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button#btnSupprimer {
      background-color: #d9534f;
      color: white;
      margin-left: 1rem;
      display: none;
    }
    button#btnValider {
      background-color: #5cb85c;
      color: white;
    }
    button#btnAjouter, button#btnSupprimerTous {
      background-color: #0275d8;
      color: white;
      margin: 0 0.5rem 1rem 0.5rem;
    }
    ul#travauxList {
      list-style: none;
      padding: 0;
      max-width: 600px;
      margin: 0 auto;
    }
    ul#travauxList li {
      background: #fff;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    ul#travauxList li .title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    ul#travauxList li .subtitle {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.3rem;
    }
    ul#travauxList li button.modifier-btn {
      background-color: #f0ad4e;
      color: white;
      border-radius: 4px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
    }
    .date-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    .date-container .calendar-icon {
      position: absolute;
      left: 10px;
      font-size: 1.2em;
      pointer-events: none;
      color: #999;
    }
    .date-container input {
      padding-left: 32px;
      width: 100%;
    }
    #importExportSection {
      text-align: center;
      margin-bottom: 2rem;
    }
    #importExportSection button {
      margin: 0 1rem;
    }
  </style>
</head>
<body>

  <h1>📋 Gestion des Travaux avec Import/Export</h1>

  <div id="importExportSection">
    <input type="file" id="importFile" accept=".txt" style="display:none" />
    <button id="btnImport">⬆ Importer bdTravaux.txt</button>
    <button id="btnExport">⬇ Exporter bdTravaux.txt</button>
  </div>

  <div style="text-align:center; margin-bottom:1rem;">
    <button id="btnAjouter">➕ Ajouter un travail</button>
    <button id="btnSupprimerTous">🗑 Supprimer tous les travaux</button>
  </div>

  <div class="form-container" id="formContainer">
    <input type="hidden" id="ficheId" />
    <label for="type">Type</label>
    <select id="type">
      <option value="MH">MH</option>
      <option value="ML">ML</option>
      <option value="PF">PF</option>
      <option value="CO">CO</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="numero">Numéro</label>
    <input type="text" id="numero" placeholder="Numéro" />

    <label for="famille">Famille</label>
    <select id="famille">
      <option value="Deco">Deco</option>
      <option value="Plomberie">Plomberie</option>
      <option value="Electricité">Electricité</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="precision">Précision</label>
    <input type="text" id="precision" placeholder="Précision (optionnelle)" />

    <label for="date">Date sélectionnée</label>
    <div class="date-container">
      <span class="calendar-icon">📅</span>
      <input type="text" id="date" placeholder="Sélectionnez une date" />
    </div>

    <div style="margin-top:1rem;">
      <button id="btnValider">Valider</button>
      <button id="btnSupprimer">Supprimer</button>
    </div>
  </div>

  <ul id="travauxList"></ul>

  <script>
    let travaux = JSON.parse(localStorage.getItem('travaux')) || [];

    // Parse une date jj/mm/aaaa en Date
    function parseDateDDMMYYYY(str) {
      if (!str) return null;
      const [d, m, y] = str.split('/');
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }

    // Affiche la liste triée
    function afficherTravaux() {
      travaux.sort((a, b) => {
        const dateA = parseDateDDMMYYYY(a.dateSelection);
        const dateB = parseDateDDMMYYYY(b.dateSelection);
        return dateA - dateB;
      });

      const list = document.getElementById('travauxList');
      list.innerHTML = '';

      travaux.forEach(item => {
        const li = document.createElement('li');

        const divText = document.createElement('div');
        divText.style.flexGrow = '1';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = `${item.type} ${item.numero}`;

        const subtitle = document.createElement('div');
        subtitle.className = 'subtitle';
        subtitle.textContent = [
          item.famille,
          item.precision || '',
          item.dateAjout,
          item.dateSelection
        ].filter(Boolean).join(' | ');

        divText.appendChild(title);
        divText.appendChild(subtitle);

        const btnModif = document.createElement('button');
        btnModif.className = 'modifier-btn';
        btnModif.textContent = '✏️ Modifier';
        btnModif.onclick = () => modifierFiche(item.id);

        li.appendChild(divText);
        li.appendChild(btnModif);

        list.appendChild(li);
      });
    }

    // Vide formulaire
    function clearForm() {
      document.getElementById('ficheId').value = '';
      document.getElementById('type').value = 'MH';
      document.getElementById('numero').value = '';
      document.getElementById('famille').value = 'Deco';
      document.getElementById('precision').value = '';
      document.getElementById('date').value = '';
      document.getElementById('btnSupprimer').style.display = 'none';
    }

    // Affiche ou cache formulaire + initialise date au besoin
    function toggleForm() {
      const form = document.getElementById('formContainer');
      const isHidden = form.style.display === 'none' || !form.style.display;
      if (isHidden) {
        form.style.display = 'block';
        clearForm();
        const dateInput = document.getElementById('date');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${dd}/${mm}/${yyyy}`;
      } else {
        form.style.display = 'none';
        clearForm();
      }
    }

    // Valide ajout ou modif
    function validerFiche() {
      const id = document.getElementById('ficheId').value;
      const type = document.getElementById('type').value;
      const numero = document.getElementById('numero').value.trim();
      const famille = document.getElementById('famille').value;
      const precision = document.getElementById('precision').value.trim();
      const dateSelection = document.getElementById('date').value;
      const dateAjout = new Date().toLocaleDateString('fr-FR');

      if (!numero || !dateSelection) {
        alert("Le numéro et la date sont requis.");
        return;
      }

      if (id) {
        // Modifier
        const i = travaux.findIndex(t => t.id == id);
        if (i !== -1) {
          travaux[i] = {
            id: Number(id),
            type,
            numero,
            famille,
            precision,
            dateAjout: travaux[i].dateAjout,
            dateSelection
          };
        }
      } else {
        // Ajouter
        const newId = travaux.length ? Math.max(...travaux.map(t => t.id)) + 1 : 1;
        travaux.push({ id: newId, type, numero, famille, precision, dateAjout, dateSelection });
      }

      localStorage.setItem('travaux', JSON.stringify(travaux));
      afficherTravaux();
      toggleForm();
    }

    // Supprimer fiche
    function supprimerFiche() {
      const id = document.getElementById('ficheId').value;
      if (confirm("Supprimer cette fiche ?")) {
        travaux = travaux.filter(t => t.id != id);
        localStorage.setItem('travaux', JSON.stringify(travaux));
        afficherTravaux();
        toggleForm();
      }
    }

    // Supprimer tous
    function supprimerTousTravaux() {
      if (confirm("❗ Cette action supprimera tous les travaux enregistrés dans le navigateur. Êtes-vous sûr ?")) {
        localStorage.removeItem('travaux');
        travaux = [];
        afficherTravaux();
        alert("Tous les travaux ont été supprimés !");
      }
    }

    // Modifier fiche existante
    function modifierFiche(id) {
      const f = travaux.find(t => t.id === id);
      if (!f) return;
      document.getElementById('ficheId').value = f.id;
      document.getElementById('type').value = f.type;
      document.getElementById('numero').value = f.numero;
      document.getElementById('famille').value = f.famille;
      document.getElementById('precision').value = f.precision;
      document.getElementById('date').value = f.dateSelection;
      document.getElementById('btnSupprimer').style.display = 'inline-block';
      document.getElementById('formContainer').style.display = 'block';
    }

    // --- Importer bdTravaux.txt ---
    function importerFichier(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const lignes = text.split(/\r?\n/).filter(l => l.trim() !== '');

        // Trouver max id actuel
        let maxId = travaux.length ? Math.max(...travaux.map(t => t.id)) : 0;

        let importCount = 0;
        lignes.forEach(line => {
          const parts = line.split('|');
          if (parts.length >= 7) {
            let [id, type, numero, famille, precision, dateAjout, dateSelection] = parts;

            // Convertir id en number et éviter doublons
            id = Number(id);
            if (isNaN(id)) return; // ignore ligne mal formée

            // Si id existe déjà, on modifie l'id en incrémentant
            if (travaux.some(t => t.id === id)) {
              maxId++;
              id = maxId;
            } else if (id > maxId) {
              maxId = id;
            }

            // Ajouter la fiche importée
            travaux.push({
              id,
              type,
              numero,
              famille,
              precision,
              dateAjout,
              dateSelection
            });
            importCount++;
          }
        });

        localStorage.setItem('travaux', JSON.stringify(travaux));
        afficherTravaux();
        alert(`Import terminé : ${importCount} fiches ajoutées.`);
      };
      reader.readAsText(file);
    }

    // --- Exporter bdTravaux.txt ---
    function exporterFichier() {
      if (travaux.length === 0) {
        alert("Aucun travail à exporter.");
        return;
      }
      // Générer texte au format id|type|numero|famille|precision|dateAjout|dateSelection
      const lines = travaux.map(t => 
        [t.id, t.type, t.numero, t.famille, t.precision, t.dateAjout, t.dateSelection].join('|')
      );

      const blob = new Blob([lines.join('\n')], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'bdTravaux.txt';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
    }

    // Initialise Flatpickr en français
    flatpickr("#date", {
      dateFormat: "d/m/Y",
      defaultDate: "today",
      locale: "fr"
    });

    // Événements
    document.getElementById('btnAjouter').addEventListener('click', toggleForm);
    document.getElementById('btnValider').addEventListener('click', validerFiche);
    document.getElementById('btnSupprimer').addEventListener('click', supprimerFiche);
    document.getElementById('btnSupprimerTous').addEventListener('click', supprimerTousTravaux);

    // Import / Export events
    const importFileInput = document.getElementById('importFile');
    document.getElementById('btnImport').addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        importerFichier(e.target.files[0]);
        e.target.value = ''; // reset input
      }
    });
    document.getElementById('btnExport').addEventListener('click', exporterFichier);

    // Affichage initial
    afficherTravaux();
  </script>

</body>
</html>
